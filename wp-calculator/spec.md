# Спецификация: Визуальный калькулятор WP (v2.0 - на основе кода)

**Feature**: Визуальный калькулятор для вычисления слабейшего предусловия (weakest precondition).

## 1. Обзор и контекст

Создан WPF-инструмент, который позволяет пользователям вычислять и визуализировать слабейшее предусловие (wp) по правилам Дейкстры. Пользователь выбирает один из трех предустановленных "сюжетов" (например, вычисление площади квадрата), который определяет начальные предусловие и постусловие. Затем пользователь выбирает тип преобразования (присваивание, ветвление, последовательность) и вводит соответствующий оператор. Система вычисляет и отображает итоговое слабейшее предусловие, а также пошаговый лог вычислений.

## 2. Пользовательские сценарии

- **UC-1: Вычисление для присваивания.** Пользователь выбирает сценарий (например, "Нахождение площади квадрата" с постусловием `a*a>0`), выбирает тип "Присваивание" и вводит оператор (например, `a := a + 1`). Система вычисляет `wp(a := a + 1, a*a > 0)`, что приводит к `(a+1)*(a+1) > 0`, и упрощает это до финального предусловия.

- **UC-2: Вычисление для последовательности.** Пользователь выбирает сценарий, тип "Последовательность" и вводит операторы через точку с запятой (например, `y := x + 2; x := 2*x + 10`). Система преобразует ввод в стек операторов и рекурсивно вычисляет `wp`, начиная с последнего оператора.

- **UC-3: Вычисление для ветвления.** Пользователь выбирает сценарий, тип "Ветвление" и вводит оператор `if` (например, `if (x > y) then max := x else max := y`). Система вычисляет `wp` для обеих веток и объединяет их в дизъюнкцию.

- **UC-4: Просмотр триады Хоара.** После успешного вычисления `wp`, пользователь может нажать кнопку "Триада Хоара", чтобы увидеть итоговую триаду `{P} S {R}`.

- **UC-5: Трассировка вычислений.** В специальном окне отображается пошаговый лог вычислений, включая промежуточные результаты замен и итоговое упрощенное предусловие.

## 3. Функциональные требования

- **FR-1:** UI предоставляет выбор из трех предустановленных сценариев, каждый со своими начальными предусловием и постусловием.
- **FR-2:** UI предоставляет выбор из трех типов преобразований: "Присваивание", "Ветвление", "Последовательность".
- **FR-3:** На основе выбора пользователя, поле для ввода оператора автозаполняется примером.
- **FR-4:** Перед вычислением `wp` производится синтаксическая валидация введенного оператора.
- **FR-5:** Система вычисляет слабейшее предусловие для операторов `assignment`, `if-then-else` и `sequence`.
- **FR-6:** Финальное предусловие, полученное после вычисления `wp`, подвергается упрощению (решаются линейные неравенства).
- **FR-7:** Система ведет пошаговый лог (трейс) всех этапов вычисления.
- **FR-8:** Результат `wp`, лог трассировки и итоговая триада Хоара отображаются в пользовательском интерфейсе.
- **FR-9:** Реализован сервисный слой (`WPCalculatorService`), который служит фасадом для всей бизнес-логики.

## 4. Архитектура и компоненты

- **WpfAppWPCalculator**: Слой представления (View и ViewModel). Отвечает за взаимодействие с пользователем и вызов сервисного слоя.
- **ClassLibraryWPCalculator**: Слой бизнес-логики.
  - **WPCalculatorService**: Фасад, координирующий работу других компонентов.
  - **WPCalculator**: Ядро, реализующее логику `wp` для разных типов операторов.
  - **ExpressionParser**: Валидатор синтаксиса вводимых пользователем операторов.
  - **InequalitySimplifier**: Компонент для решения и упрощения линейных неравенств.
  - **WpTrace**: Статический класс для глобального сбора логов вычислений.
- **TestProjectWPCalculator1**: Проект с модульными тестами (xUnit).

## 5. Вне рамок (Out of Scope)

- Циклы (`while`).
- Сложные типы данных и структуры.
- Решение нелинейных неравенств.